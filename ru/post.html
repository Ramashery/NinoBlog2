<!DOCTYPE html>
<html lang="en"> <!-- Язык будет установлен динамически -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Blog Post | Nino Kartsivadze</title>
    <meta name="description" content="An article from the art blog of Nino Kartsivadze.">
    <link rel="canonical" href="" /> <!-- Заглушка, будет заменена -->

    <meta property="og:title" content="Blog Post" />
    <meta property="og:type" content="article" />
    <meta property="og:description" content="An article from the art blog of Nino Kartsivadze." />
    <meta property="og:image" content="https://minankari.art/placeholder.jpg" />
    <meta property="og:url" content="" />
    <meta property="og:site_name" content="CLOISONNE ENAMEL | Nino Kartsivadze" />
    
    <style>
        :root { --primary: #D4AF37; --bg: #121212; --glass: rgba(255, 255, 255, 0.05); --shadow-dark: rgba(0, 0, 0, 0.2); --shadow-light: rgba(255, 255, 255, 0.05); --text-light: rgba(255, 255, 255, 0.9); }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Montserrat', sans-serif; }
        body { background: var(--bg); color: var(--text-light); min-height: 100vh; position: relative; }
        #particles-js { position: fixed; width: 100%; height: 100%; top: 0; left: 0; z-index: -1; }
        .post-container, .related-container { max-width: 800px; margin: 2rem auto; padding: 2rem; background: var(--glass); border-radius: 24px; box-shadow: 8px 8px 16px var(--shadow-dark), -8px -8px 16px var(--shadow-light); backdrop-filter: blur(12px); border: 1px solid rgba(212, 175, 55, 0.1); opacity: 0; transition: opacity 0.5s; }
        .post-container.loaded, .related-container.loaded { opacity: 1; }
        .post-header { text-align: center; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid rgba(212, 175, 55, 0.2); }
        .post-title { font-size: clamp(1.8rem, 5vw, 2.8rem); color: var(--primary); font-weight: 300; margin-bottom: 0.5rem; }
        .post-subtitle { font-size: clamp(1rem, 3vw, 1.2rem); font-weight: 300; opacity: 0.8; }
        .post-meta { text-align: center; margin-bottom: 2rem; font-size: 0.9rem; opacity: 0.7; }
        .slideshow-container { width: 100%; margin-bottom: 2rem; aspect-ratio: 16 / 9; position: relative; border-radius: 16px; overflow: hidden; box-shadow: 4px 4px 8px var(--shadow-dark); -webkit-mask-image: -webkit-radial-gradient(white, black); }
        .slideshow-item { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; opacity: 0; transition: opacity 1.2s ease-in-out; }
        .slideshow-item.active { opacity: 1; }
        .slideshow-item-video { width: 140%; height: 140%; top: -20%; left: -20%; }
        .slideshow-item-video iframe { width: 100%; height: 100%; border: none; }
        .slideshow-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; cursor: grab; }
        .post-content { line-height: 1.8; font-size: 1.1rem; }
        .post-content p { margin-bottom: 1.5em; }
        .post-content .embedded-image { width: 100%; height: auto; border-radius: 16px; margin: 1rem 0; }
        .post-content .embedded-video { width: 100%; aspect-ratio: 16/9; border-radius: 16px; margin: 1rem 0; border: none; }
        .back-link { display: block; text-align: center; margin-top: 2rem; color: var(--primary); text-decoration: none; }
        .message-container { text-align: center; font-size: 1.5rem; padding: 5rem 1rem; color: var(--primary); }
        .related-container { display: none; } .related-title { font-size: 2rem; color: var(--primary); font-weight: 300; text-align: center; margin-bottom: 2rem; }
        .related-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 1.5rem; }
        .blog-post-card { display: flex; flex-direction: column; background: var(--glass); border-radius: 24px; box-shadow: 8px 8px 16px var(--shadow-dark), -8px -8px 16px var(--shadow-light); backdrop-filter: blur(12px); transition: transform 0.4s, box-shadow 0.4s; overflow: hidden; border: 1px solid rgba(212, 175, 55, 0.1); text-decoration: none; color: var(--text-light); }
        .blog-post-card:hover { transform: translateY(-8px); }
        .blog-post-card .slideshow-container { height: 180px; clip-path: polygon(0 0, 100% 0, 100% 85%, 0 100%); transition: clip-path 0.5s ease; }
        .blog-post-card:hover .slideshow-container { clip-path: polygon(0 0, 100% 0, 100% 100%, 0 85%); }
        .blog-post-card .post-card-content { padding: 1rem; }
        .blog-post-card .post-card-title { font-size: 1rem; margin-bottom: 0.5rem; color: var(--primary); }
        .blog-post-card .post-card-date { font-size: 0.8rem; opacity: 0.6; margin-top: 0.5rem; }
    </style>
</head>
<body>
    <script type="application/ld+json" id="post-schema-json">
    {"@context": "https://schema.org", "@type": "BlogPosting", "headline": "Blog Post Title", "image": [], "author": {"@type": "Person", "name": "Nino Kartsivadze"}, "publisher": {"@type": "Organization", "name": "CLOISONNE ENAMEL | Nino Kartsivadze", "logo": {"@type": "ImageObject", "url": "https://minankari.art/placeholder.jpg"}}, "datePublished": ""}
    </script>
    <div id="particles-js"></div>
    <div id="message-container" class="message-container">Loading article...</div>
    <div id="page-content-wrapper"></div>
    <div class="related-container" id="related-posts-container">
        <h2 class="related-title">Read more articles</h2>
        <div class="related-grid" id="related-posts-grid"></div>
    </div>
    
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        window.onYouTubeIframeAPIReady = function() {};

        function isYoutubeUrl(url) { return /^(https?:\/\/)?(www\.)?(youtube\.com|youtu\.?be)\/.+$/.test(url); }
        function getYoutubeVideoId(url) { try { const urlObj = new URL(url); return (urlObj.hostname === 'youtu.be') ? urlObj.pathname.slice(1) : urlObj.searchParams.get('v'); } catch (e) { return null; } }
        function getYoutubeEmbedUrl(videoId, autoPlayMuted = false) { if(!videoId) return null; const params = new URLSearchParams({ enablejsapi: 1, origin: window.location.origin }); if(autoPlayMuted) { params.set('autoplay', 1); params.set('mute', 1); params.set('loop', 1); params.set('playlist', videoId); params.set('controls', 0); } return `https://www.youtube.com/embed/${videoId}?${params.toString()}`; }

        function updateMetaTags(post, langData) {
            const pageUrl = window.location.href;
            const seoTitle = langData.seoTitle || langData.title;
            const metaDescription = langData.metaDescription || (langData.subtitle || (langData.content ? langData.content.substring(0, 160).replace(/\[.*?\]|\n/g, ' ').trim() : ''));
            const firstImage = post.mediaUrls && post.mediaUrls.length > 0 ? post.mediaUrls.filter(url => !isYoutubeUrl(url))[0] : 'https://minankari.art/placeholder.jpg';
            document.title = `${seoTitle} | Blog`;
            document.querySelector('meta[name="description"]').setAttribute('content', metaDescription);
            document.querySelector('link[rel="canonical"]').setAttribute('href', pageUrl);
            document.querySelector('meta[property="og:title"]').setAttribute('content', seoTitle);
            document.querySelector('meta[property="og:description"]').setAttribute('content', metaDescription);
            document.querySelector('meta[property="og:url"]').setAttribute('content', pageUrl);
            document.querySelector('meta[property="og:image"]').setAttribute('content', firstImage);
            const schemaScript = document.getElementById('post-schema-json');
            const schema = {
                "@context": "https://schema.org", "@type": "BlogPosting", "mainEntityOfPage": { "@type": "WebPage", "@id": pageUrl }, "headline": langData.title, "description": metaDescription,
                "image": post.mediaUrls ? post.mediaUrls.filter(url => !isYoutubeUrl(url)) : [], "author": { "@type": "Person", "name": "Nino Kartsivadze" },
                "publisher": { "@type": "Organization", "name": "CLOISONNE ENAMEL | Nino Kartsivadze", "logo": { "@type": "ImageObject", "url": "https://minankari.art/placeholder.jpg" } },
                "datePublished": post.timestamp ? new Date(post.timestamp.seconds * 1000).toISOString() : new Date().toISOString()
            };
            schemaScript.textContent = JSON.stringify(schema, null, 2);
        }

        function parseContent(content) {
            const imageRegex = /\[image:\s*(https?:\/\/[^\s\]]+)\s*\]/g;
            const youtubeRegex = /\[youtube:\s*(https?:\/\/[^\s\]]+)\s*\]/g;
            
            let htmlContent = content
                .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") // Sanitize first
                .replace(imageRegex, (match, url) => `<img src="${url}" class="embedded-image" alt="Embedded content" loading="lazy">`)
                .replace(youtubeRegex, (match, url) => {
                    const videoId = getYoutubeVideoId(url);
                    const embedUrl = getYoutubeEmbedUrl(videoId, false);
                    return embedUrl ? `<iframe src="${embedUrl}" class="embedded-video" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>` : '';
                })
                .split('\n').filter(p => p.trim() !== '').map(p => `<p>${p}</p>`).join('');
            
            return htmlContent;
        }

        function createMediaElement(mediaUrl, title) { 
            if (isYoutubeUrl(mediaUrl)) {
                const videoId = getYoutubeVideoId(mediaUrl);
                const embedUrl = getYoutubeEmbedUrl(videoId, true);
                if (!embedUrl) return null;
                const wrapper = document.createElement('div');
                wrapper.className = 'slideshow-item slideshow-item-video';
                const iframe = document.createElement('iframe');
                iframe.src = embedUrl; iframe.title = title + ' - YouTube Video';
                wrapper.appendChild(iframe);
                return wrapper;
            } else {
                const img = document.createElement('img');
                img.src = mediaUrl; img.alt = title; img.className = 'slideshow-item'; img.loading = 'lazy';
                return img;
            }
        }
        
        function setupSlideshow(container) { if (!container) return; const slides = Array.from(container.querySelectorAll('.slideshow-item')); if (slides.length <= 1) { if (slides[0]) slides[0].classList.add('active'); return; } const overlay = document.createElement('div'); overlay.className = 'slideshow-overlay'; container.appendChild(overlay); let currentIndex = 0; let intervalId = setInterval(() => showSlide(currentIndex + 1), 5000); function showSlide(index) { const oldSlide = slides[currentIndex]; if (oldSlide) oldSlide.classList.remove('active'); currentIndex = (index + slides.length) % slides.length; const newSlide = slides[currentIndex]; if (newSlide) setTimeout(() => newSlide.classList.add('active'), 1200); } function manualSlide(direction) { clearInterval(intervalId); showSlide(currentIndex + direction); startAutoplay(); } function startAutoplay() { clearInterval(intervalId); intervalId = setInterval(() => showSlide(currentIndex + 1), 5000); } let touchStartX = 0; overlay.addEventListener('mousedown', e => { touchStartX = e.clientX; clearInterval(intervalId); }); overlay.addEventListener('mouseup', e => { if (e.clientX < touchStartX - 50) manualSlide(1); else if (e.clientX > touchStartX + 50) manualSlide(-1); startAutoplay(); }); overlay.addEventListener('mouseleave', startAutoplay); showSlide(0); startAutoplay(); }

        async function loadRelatedPosts(db, currentPostId, currentLang) {
            const container = document.getElementById('related-posts-container');
            const grid = document.getElementById('related-posts-grid');
            if (!container || !grid) return;
            try {
                const snapshot = await db.collection('blog_posts').orderBy('timestamp', 'desc').limit(10).get();
                const relatedPosts = [];
                for(const doc of snapshot.docs) {
                    if (doc.id === currentPostId) continue;
                    const post = doc.data();
                    if(post.i18n && post.i18n[currentLang] && post.i18n[currentLang].slug) {
                        relatedPosts.push({ ...post, id: doc.id });
                    }
                    if (relatedPosts.length >= 3) break;
                }

                if (relatedPosts.length > 0) {
                    container.style.display = 'block';
                    grid.innerHTML = relatedPosts.map(post => {
                        const langData = post.i18n[currentLang];
                        const mediaUrl = post.mediaUrls && post.mediaUrls.length > 0 ? post.mediaUrls[0] : 'https://minankari.art/placeholder.jpg';
                        const postDate = post.timestamp ? new Date(post.timestamp.seconds * 1000).toLocaleDateString() : '';
                        
                        return `
                        <a href="../${currentLang}/post.html?slug=${langData.slug}" class="blog-post-card">
                            <div class="slideshow-container">
                                <img src="${mediaUrl}" class="slideshow-item active" alt="${langData.title}" loading="lazy">
                            </div>
                            <div class="post-card-content">
                                <h3 class="post-card-title">${langData.title}</h3>
                                <p class="post-card-date">${postDate}</p>
                            </div>
                        </a>`;
                    }).join('');
                    setTimeout(() => container.classList.add('loaded'), 50);
                }
            } catch(error) { console.error("Error loading related posts:", error); }
        }

        async function initializePostPage() {
            const firebaseConfig = { apiKey: "AIzaSyAxOUOxaufE60eVuyOq_P66MJ9ls_7p470", authDomain: "nini-shop-7c89d.firebaseapp.com", projectId: "nini-shop-7c89d", storageBucket: "nini-shop-7c89d.appspot.com", messagingSenderId: "595482257713", appId: "1:595482257713:web:3e3d3bf75f03c08e58a810", measurementId: "G-0HX4N09DYT" };
            if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
            const db = firebase.firestore();
            const particleConfig = { "particles": { "number": { "value": 80, "density": { "enable": true, "value_area": 800 }}, "color": { "value": "#D4AF37" }, "shape": { "type": "circle" }, "opacity": { "value": 0.5, "random": true, "anim": { "enable": true, "speed": 1, "opacity_min": 0.1 }}, "size": { "value": 3, "random": true, "anim": { "enable": true, "speed": 2, "size_min": 0.1 }}, "line_linked": { "enable": true, "distance": 150, "color": "#D4AF37", "opacity": 0.2, "width": 1 }, "move": { "enable": true, "speed": 1, "direction": "none", "random": true, "out_mode": "out" }}, "interactivity": { "events": { "onhover": { "enable": true, "mode": "grab" }, "onclick": { "enable": true, "mode": "push" }}}, "retina_detect": true };
            if (document.getElementById('particles-js')) { particlesJS('particles-js', particleConfig); }
            const messageContainer = document.getElementById('message-container');
            const params = new URLSearchParams(window.location.search);
            const postSlug = params.get('slug');
            const postLang = window.location.pathname.split('/').filter(p => p && p.length === 2)[0] || 'en';

            if (!postSlug) { messageContainer.textContent = 'Error: Post not specified.'; return; }
            try {
                const queryField = `i18n.${postLang}.slug`;
                const snapshot = await db.collection('blog_posts').where(queryField, '==', postSlug).limit(1).get();
                if (snapshot.empty) {
                    messageContainer.textContent = `Sorry, the article could not be found. (slug=${postSlug}, lang=${postLang})`; return;
                }
                const postDoc = snapshot.docs[0];
                const postData = postDoc.data();
                
                if (postData.i18n && postData.i18n[postLang]) {
                    const langData = postData.i18n[postLang];
                    document.documentElement.lang = postLang;
                    
                    updateMetaTags(postData, langData);
                    const formattedContent = parseContent(langData.content);
                    const postDate = postData.timestamp ? new Date(postData.timestamp.seconds * 1000).toLocaleDateString() : '';
                    const mediaHTML = (postData.mediaUrls || []).map(url => createMediaElement(url, langData.title)?.outerHTML || '').join('');

                    const pageHTML = `
                        <div class="post-container" id="post-content">
                            <div class="post-header">
                                <h1 class="post-title">${langData.title}</h1>
                                ${langData.subtitle ? `<h2 class="post-subtitle">${langData.subtitle}</h2>` : ''}
                            </div>
                            <p class="post-meta">Published on ${postDate}</p>
                            ${mediaHTML ? `<div class="slideshow-container">${mediaHTML}</div>` : ''}
                            <div class="post-content">${formattedContent}</div>
                            <a href="../blog.html" class="back-link">← Back to Blog</a>
                        </div>`;
                    document.getElementById('page-content-wrapper').innerHTML = pageHTML;
                    messageContainer.style.display = 'none';
                    const postContainer = document.getElementById('post-content');
                    setTimeout(() => postContainer.classList.add('loaded'), 50);
                    if (mediaHTML) { setupSlideshow(postContainer.querySelector('.slideshow-container')); }

                    loadRelatedPosts(db, postDoc.id, postLang);

                } else {
                    messageContainer.textContent = 'Article content for this language is not available.';
                }
            } catch (error) {
                console.error("Critical error loading post:", error);
                messageContainer.textContent = 'An error occurred while loading the article.';
            }
        }
        initializePostPage();
    </script>
</body>
</html>